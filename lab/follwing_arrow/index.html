<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Following arrow</title>
    <script type="text/javascript" src="../../jquery/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
      var objdiv = null;
      var canvas = null;
      var wrapper = null;
      var ctx2d = null;
      var arrow = null;

      var vw = 0;
      var vh = 0;
      var objdiv_x = 0;
      var objdiv_y = 0;
      var objdiv_h = 0;
      var objdiv_w = 0;
      var mouse_x = 0;
      var mouse_y = 0;
      var objdiv_bw = 0; // Border width
      var objdiv_br = 10; // Border radius
      var arrow_w = 0;
      var arrow_h = 0;

      $(document).ready(function() {
        wrapper = $("#kolkturmviewer");
        canvas = $("<canvas>").appendTo(wrapper).get(0);
        console.log("Info: " + canvas);
        ctx2d = canvas.getContext('2d');
        objdiv = $("#objdiv");
        arrow = $("#arrow");

        objdiv_w = objdiv.outerWidth();
        objdiv_h = objdiv.outerHeight();
        objdiv_bw = (objdiv_w - objdiv.innerWidth()) / 2;

        arrow_w = arrow.width();
        arrow_h = arrow.height();

        $(window).resize(resizeHandler);
        $(document).mousemove(mouseMoveHandler);

        resizeHandler();
      });

      function resizeHandler() {
        vw = $(wrapper).width();
        vh = $(wrapper).height();

        canvas.width = vw;
        canvas.height = vh;

        objdiv_x = (vw - objdiv_w) / 2;
        objdiv_y = (vh - objdiv_h) / 2;

        console.log("objdiv_w = " + objdiv_w + " objdiv_h = " + objdiv_h);
        console.log("vw = " + vw + " vh = " + vh);

        objdiv.css({top: objdiv_y, left: objdiv_x});

        draw();
      }

      function mouseMoveHandler(event) {
        mouse_x = event.pageX;
        mouse_y = event.pageY;

        draw();
      }

      function draw() {
        ctx2d.clearRect(0, 0, vw, vh);

        // Horizontal line
        ctx2d.beginPath();
        ctx2d.strokeStyle = "black";
        ctx2d.moveTo(0, vh/2);
        ctx2d.lineTo(vw, vh/2);
        ctx2d.stroke();

        // Vertical line
        ctx2d.beginPath();
        ctx2d.strokeStyle = "black";
        ctx2d.moveTo(vw/2, 0);
        ctx2d.lineTo(vw/2, vh);
        ctx2d.stroke();

        // Vertical line which marks left part after the round corners
        ctx2d.beginPath();
        ctx2d.strokeStyle = "grey";
        ctx2d.moveTo(objdiv_x + 10, 0);
        ctx2d.lineTo(objdiv_x + 10, vh);
        ctx2d.stroke();

        // Vertical line which marks right part before the round corners
        ctx2d.beginPath();
        ctx2d.strokeStyle = "grey";
        ctx2d.moveTo(objdiv_x + objdiv_w - 10, 0);
        ctx2d.lineTo(objdiv_x + objdiv_w - 10, vh);
        ctx2d.stroke();

        ctx2d.beginPath();
        ctx2d.strokeStyle = "red";
        ctx2d.arc(mouse_x, mouse_y, 10, 0, 2 * Math.PI);
        ctx2d.stroke();
        ctx2d.closePath();

        var xmin = objdiv_x + objdiv_br;
        var xmax = objdiv_x + objdiv_w - objdiv_br;
        var ymin = objdiv_y + objdiv_br;
        var ymax = objdiv_y + objdiv_h - objdiv_br;

        var arrow_x = 0;
        var arrow_y = 0;
        var alpha = 0;
        var arrow_spacing = 3;

        var angle_center_x = vw / 2;
        var angle_center_y = vh / 2;

        /*
        * Handle arrow around object information div (objdiv)
        */

        /* Object is above the straight part of the objdiv */
        if ((mouse_x >= xmin) && (mouse_x <= xmax) && (mouse_y < objdiv_y)) {
          arrow_x = mouse_x - objdiv_x - (arrow_w / 2) - objdiv_bw;
          arrow_y = -arrow_h - arrow_spacing - objdiv_bw;
        /* Object is past the upper right corner of the objdiv */
        } else if ((mouse_x > xmax) && (mouse_y < ymin)) {
          angle_center_x = xmax;
          angle_center_y = ymin;

          // Calculate angle for arrow
          var a = mouse_x - xmax; // Opposite leg of alpha
          var b = ymin - mouse_y; // Leg of alpha
          var c = Math.sqrt(a*a + b*b) // Hypotenuse
          alpha = Math.asin(a / c); // Angle of alpha in radian

          arrow_x = objdiv_w - objdiv_br - (arrow_w / 2) - objdiv_bw + (Math.sin(alpha) * (objdiv_br + arrow_spacing + (arrow_w / 2)));
          arrow_y = objdiv_br - (arrow_h / 2) - (Math.cos(alpha) * (objdiv_br + (arrow_h / 2) + arrow_spacing + objdiv_bw));
        /* Object is to the right of the straight part of the objdiv */
        } else if ((mouse_x > (objdiv_x + objdiv_w)) && (mouse_y >= ymin) && (mouse_y <= ymax)) {
          arrow_x = objdiv_w + arrow_spacing - objdiv_bw;
          arrow_y = mouse_y - objdiv_y - (arrow_h / 2) - objdiv_bw;
          alpha = Math.PI / 2;
        /* Object is past the lower right corner of the objdiv */
        } else if ((mouse_x > xmax) && (mouse_y > ymax)) {
          angle_center_x = xmax;
          angle_center_y = ymax;

          // Calculate angle for arrow
          var a = mouse_y - ymax; // Opposite leg of alpha
          var b = mouse_x - xmax; // Leg of alpha
          var c = Math.sqrt(a*a + b*b) // Hypotenuse
          alpha = (Math.PI / 2) + Math.asin(a / c); // Angle of alpha in radian

          arrow_x = objdiv_w - objdiv_br - (arrow_w / 2) - objdiv_bw + (Math.sin(alpha) * (objdiv_br + arrow_spacing + (arrow_w / 2)));
          arrow_y = objdiv_h - objdiv_br - (arrow_h / 2) - (Math.cos(alpha) * (objdiv_br + (arrow_h / 2) + arrow_spacing - objdiv_bw));
        /* Object is below the straight part of the objdiv */
        } else if ((mouse_x >= xmin) && (mouse_x <= xmax) && (mouse_y > (objdiv_y + objdiv_h))) {
          arrow_x = mouse_x - objdiv_x - (arrow_w / 2) - objdiv_bw;
          arrow_y = objdiv_h + arrow_spacing - objdiv_bw;
          alpha = Math.PI;
        /* Object is past the lower left corner of the objdiv */
        } else if ((mouse_x < xmin) && (mouse_y > ymax)) {
          angle_center_x = xmin;
          angle_center_y = ymax;

          // Calculate angle for arrow
          var a = xmin - mouse_x; // Opposite leg of alpha
          var b = mouse_y - ymax; // Leg of alpha
          var c = Math.sqrt(a*a + b*b) // Hypotenuse
          alpha = Math.PI + Math.asin(a / c); // Angle of alpha in radian

          arrow_x = objdiv_br - (arrow_w / 2) - 1 + (Math.sin(alpha) * (objdiv_br + arrow_spacing + (arrow_w / 2)));
          arrow_y = objdiv_h - objdiv_br - (arrow_h / 2) - (Math.cos(alpha) * (objdiv_br + (arrow_h / 2) + arrow_spacing - objdiv_bw));
        /* Object is to the right of the straight part of the objdiv */
        } else if ((mouse_x < objdiv_x) && (mouse_y >= ymin) && (mouse_y <= ymax)) {
          arrow_x = -arrow_w - arrow_spacing - objdiv_bw;
          arrow_y = mouse_y - objdiv_y - (arrow_h / 2) - objdiv_bw;
          alpha = Math.PI / 2 * 3;
        /* Object is past the upper left corner of the objdiv */
        } else if ((mouse_x < xmin) && (mouse_y < ymin)) {
          angle_center_x = xmin;
          angle_center_y = ymin;

          // Calculate angle for arrow
          var a = ymin - mouse_y; // Opposite leg of alpha
          var b = xmin - mouse_x; // Leg of alpha
          var c = Math.sqrt(a*a + b*b) // Hypotenuse
          alpha = (Math.PI / 2 * 3) + Math.asin(a / c); // Angle of alpha in radian

          arrow_x = objdiv_br - (arrow_w / 2) - objdiv_bw + (Math.sin(alpha) * (objdiv_br + arrow_spacing + (arrow_w / 2)));
          arrow_y = objdiv_br - (arrow_h / 2) - (Math.cos(alpha) * (objdiv_br + (arrow_h / 2) + arrow_spacing + objdiv_bw));
        /* None of the above cases and the case that should never happen */
        } else {
          arrow_x = (objdiv_w - arrow_w - 2) / 2;
          arrow_y = (objdiv_h - arrow_h - 2) / 2;

          // Calculate angle for arrow
          var a = mouse_x - vw/2; // Opposite leg of alpha
          var b = vh/2 - mouse_y; // Leg of alpha
          var c = Math.sqrt(a*a + b*b) // Hypotenuse
          alpha = Math.asin(a / c); // Angle of alpha in radian
        }

        ctx2d.beginPath();
        ctx2d.strokeStyle = "red";
        ctx2d.moveTo(angle_center_x, angle_center_y);
        ctx2d.lineTo(mouse_x, mouse_y);
        ctx2d.stroke();

        arrow.css({top: arrow_y, left: arrow_x, transform: "rotate(" + alpha + "rad)"});
      }
    </script>
    <style>
      body, html {
        margin: 0px;
        padding: 0px;
      }

      .ktv-objinfo {
          position: absolute;
          /*display: none;*/
          background: black;
          border: 1px solid white;
          padding: 10px;
          color: white;
          border-radius: 10px;
          box-shadow: 0 0 7px black;
          white-space: nowrap;
      }

      #kolkturmviewer {
        height: 100vh;
        background-color: aqua;
      }

      #kolkturmviewer canvas {
        vertical-align: bottom;
      }

      #arrow {
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <div id="kolkturmviewer">
      <div id="objdiv" class="ktv-objinfo">
        <svg id="arrow"
          width="20"
          height="20"
          xmlns="http://www.w3.org/2000/svg">
          <path id="lineAB" d="M 0 20 l 10 -20 l 10 20 q -10 -5 -20 0" fill="black" stroke="white" />
        </svg>
        <!-- <div id="arrow" style="display: block; width: 20px; height: 20px; border: 0; background-color: whitesmoke;"></div> -->
        What is that?
      </div>
    </div>
  </body>
</html>
