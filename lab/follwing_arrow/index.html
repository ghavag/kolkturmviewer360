<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Following arrow</title>
    <script type="text/javascript" src="../../jquery/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
      var objdiv = null;
      var canvas = null;
      var wrapper = null;
      var ctx2d = null;
      var arrow = null;

      var vw = 0;
      var vh = 0;
      var objdiv_x = 0;
      var objdiv_y = 0;
      var objdiv_h = 0;
      var objdiv_w = 0;
      var objdiv_min_x = 0;
      var objdiv_max_x = 0;
      var objdiv_min_y = 0;
      var objdiv_max_y = 0;
      var mouse_x = null;
      var mouse_y = null;
      var mouseclicked = false;
      var objdiv_bw = 0; // Border width
      var objdiv_br = 10; // Border radius
      var arrow_w = 0;
      var arrow_h = 0;
      var object_x = 0;
      var object_y = 0;
      var arrow_spacing = 3;

      $(document).ready(function() {
        wrapper = $("#kolkturmviewer");
        canvas = $("<canvas>").appendTo(wrapper).get(0);
        console.log("Info: " + canvas);
        ctx2d = canvas.getContext('2d');
        objdiv = $("#objdiv");
        arrow = $("#arrow");

        objdiv_w = objdiv.outerWidth();
        objdiv_h = objdiv.outerHeight();
        objdiv_bw = (objdiv_w - objdiv.innerWidth()) / 2;

        arrow_w = arrow.width();
        arrow_h = arrow.height();

        $(window).resize(resizeHandler);
        $(document).mousemove(mouseMoveHandler);
        $(canvas).mousedown(mouseDownHandler);
        $(document).mouseup(mouseUpHandler); // Mouse up event must be bound to the document

        object_x = $(wrapper).width() / 2;
        object_y = $(wrapper).height() / 2;

        resizeHandler();
      });

      function resizeHandler() {
        vw = $(wrapper).width();
        vh = $(wrapper).height();

        canvas.width = vw;
        canvas.height = vh;

        objdiv_min_x = arrow_w + arrow_spacing;
        objdiv_max_x = vw - objdiv_w - arrow_w - arrow_spacing;
        objdiv_min_y = arrow_h + arrow_spacing;
        objdiv_max_y = vh - objdiv_h - arrow_h - arrow_spacing;

        draw();
      }

      function mouseMoveHandler(event) {
        if (mouseclicked) {
          if (mouse_x != null && mouse_y != null) {
            var deltax = (event.pageX - mouse_x);
            var deltay = (event.pageY - mouse_y);
            object_x = Math.min(Math.max(object_x + deltax, -200), vw + 200);
            object_y = Math.min(Math.max(object_y + deltay, -200), vh + 200);

            draw();
          }

          mouse_x = event.pageX;
          mouse_y = event.pageY;

          console.log("Object position (x, y): " + object_x + ", " + object_y);
        }
      }

      function mouseDownHandler(event) { // Left mouse button
        mouseclicked = (event.which == 1);
      }

      function mouseUpHandler(event) {
        if (event.which == 1) { // Left mouse button
          mouseclicked = false;
          mouse_x = mouse_y = null;
        }
      }

      function draw() {
        /*
        * Handle object information div (objdiv) following the object
        */

        var objdiv_min_x = arrow_w + arrow_spacing;
        var objdiv_max_x = vw - objdiv_w - arrow_w - arrow_spacing;
        var objdiv_min_y = arrow_h + arrow_spacing;
        var objdiv_max_y = vh - objdiv_h - arrow_h - arrow_spacing;

        objdiv_x = Math.min(Math.max(object_x - objdiv_w / 2, objdiv_min_x), objdiv_max_x);
        objdiv_y = Math.min(object_y - objdiv_h - arrow_h - arrow_spacing, objdiv_max_y);

        // If objdiv left screen to the top re-arrange
        if (objdiv_y < 0) {
          objdiv_y = Math.max(object_y + arrow_h + arrow_spacing, objdiv_min_y);
        }

        objdiv.css({top: objdiv_y, left: objdiv_x});

        /*
        * Handle arrow around object information div (objdiv)
        */

        var angle_center_x = objdiv_x + objdiv_w / 2;
        var angle_center_y = objdiv_y + objdiv_h / 2;

        var arrow_x = 0;
        var arrow_y = 0;
        var alpha = 0;

        var xmin = objdiv_x + objdiv_br;
        var xmax = objdiv_x + objdiv_w - objdiv_br;
        var ymin = objdiv_y + objdiv_br;
        var ymax = objdiv_y + objdiv_h - objdiv_br;

        /* Object is above the straight part of the objdiv */
        if ((object_x >= xmin) && (object_x <= xmax) && (object_y < objdiv_y)) {
          arrow_x = object_x - objdiv_x - (arrow_w / 2) - objdiv_bw;
          arrow_y = -arrow_h - arrow_spacing - objdiv_bw;
        /* Object is past the upper right corner of the objdiv */
        } else if ((object_x > xmax) && (object_y < ymin)) {
          angle_center_x = xmax;
          angle_center_y = ymin;

          // Calculate angle for arrow
          var a = object_x - xmax; // Opposite leg of alpha
          var b = ymin - object_y; // Leg of alpha
          var c = Math.sqrt(a*a + b*b) // Hypotenuse
          alpha = Math.asin(a / c); // Angle of alpha in radian

          arrow_x = objdiv_w - objdiv_br - (arrow_w / 2) - objdiv_bw + (Math.sin(alpha) * (objdiv_br + arrow_spacing + (arrow_w / 2)));
          arrow_y = objdiv_br - (arrow_h / 2) - (Math.cos(alpha) * (objdiv_br + (arrow_h / 2) + arrow_spacing + objdiv_bw));
        /* Object is to the right of the straight part of the objdiv */
        } else if ((object_x > (objdiv_x + objdiv_w)) && (object_y >= ymin) && (object_y <= ymax)) {
          arrow_x = objdiv_w + arrow_spacing - objdiv_bw;
          arrow_y = object_y - objdiv_y - (arrow_h / 2) - objdiv_bw;
          alpha = Math.PI / 2;
        /* Object is past the lower right corner of the objdiv */
        } else if ((object_x > xmax) && (object_y > ymax)) {
          angle_center_x = xmax;
          angle_center_y = ymax;

          // Calculate angle for arrow
          var a = object_y - ymax; // Opposite leg of alpha
          var b = object_x - xmax; // Leg of alpha
          var c = Math.sqrt(a*a + b*b) // Hypotenuse
          alpha = (Math.PI / 2) + Math.asin(a / c); // Angle of alpha in radian

          arrow_x = objdiv_w - objdiv_br - (arrow_w / 2) - objdiv_bw + (Math.sin(alpha) * (objdiv_br + arrow_spacing + (arrow_w / 2)));
          arrow_y = objdiv_h - objdiv_br - (arrow_h / 2) - (Math.cos(alpha) * (objdiv_br + (arrow_h / 2) + arrow_spacing - objdiv_bw));
        /* Object is below the straight part of the objdiv */
        } else if ((object_x >= xmin) && (object_x <= xmax) && (object_y > (objdiv_y + objdiv_h))) {
          arrow_x = object_x - objdiv_x - (arrow_w / 2) - objdiv_bw;
          arrow_y = objdiv_h + arrow_spacing - objdiv_bw;
          alpha = Math.PI;
        /* Object is past the lower left corner of the objdiv */
        } else if ((object_x < xmin) && (object_y > ymax)) {
          angle_center_x = xmin;
          angle_center_y = ymax;

          // Calculate angle for arrow
          var a = xmin - object_x; // Opposite leg of alpha
          var b = object_y - ymax; // Leg of alpha
          var c = Math.sqrt(a*a + b*b) // Hypotenuse
          alpha = Math.PI + Math.asin(a / c); // Angle of alpha in radian

          arrow_x = objdiv_br - (arrow_w / 2) - 1 + (Math.sin(alpha) * (objdiv_br + arrow_spacing + (arrow_w / 2)));
          arrow_y = objdiv_h - objdiv_br - (arrow_h / 2) - (Math.cos(alpha) * (objdiv_br + (arrow_h / 2) + arrow_spacing - objdiv_bw));
        /* Object is to the right of the straight part of the objdiv */
        } else if ((object_x < objdiv_x) && (object_y >= ymin) && (object_y <= ymax)) {
          arrow_x = -arrow_w - arrow_spacing - objdiv_bw;
          arrow_y = object_y - objdiv_y - (arrow_h / 2) - objdiv_bw;
          alpha = Math.PI / 2 * 3;
        /* Object is past the upper left corner of the objdiv */
        } else if ((object_x < xmin) && (object_y < ymin)) {
          angle_center_x = xmin;
          angle_center_y = ymin;

          // Calculate angle for arrow
          var a = ymin - object_y; // Opposite leg of alpha
          var b = xmin - object_x; // Leg of alpha
          var c = Math.sqrt(a*a + b*b) // Hypotenuse
          alpha = (Math.PI / 2 * 3) + Math.asin(a / c); // Angle of alpha in radian

          arrow_x = objdiv_br - (arrow_w / 2) - objdiv_bw + (Math.sin(alpha) * (objdiv_br + arrow_spacing + (arrow_w / 2)));
          arrow_y = objdiv_br - (arrow_h / 2) - (Math.cos(alpha) * (objdiv_br + (arrow_h / 2) + arrow_spacing + objdiv_bw));
        /* None of the above cases and the case that should never happen */
        } else {
          arrow_x = (objdiv_w - arrow_w - 2) / 2;
          arrow_y = (objdiv_h - arrow_h - 2) / 2;

          // Calculate angle for arrow
          var a = object_x - vw/2; // Opposite leg of alpha
          var b = vh/2 - object_y; // Leg of alpha
          var c = Math.sqrt(a*a + b*b) // Hypotenuse
          alpha = Math.asin(a / c); // Angle of alpha in radian
        }

        arrow.css({top: arrow_y, left: arrow_x, transform: "rotate(" + alpha + "rad)"});

        /*
        * Do canvas work
        */

        var objdiv_center_x = objdiv_x + objdiv_w / 2;
        var objdiv_center_y = objdiv_y + objdiv_h / 2;

        // Clear everything
        ctx2d.clearRect(0, 0, vw, vh);

        // Horizontal line
        ctx2d.beginPath();
        ctx2d.strokeStyle = "black";
        ctx2d.moveTo(0, objdiv_center_y);
        ctx2d.lineTo(vw, objdiv_center_y);
        ctx2d.stroke();

        // Vertical line
        ctx2d.beginPath();
        ctx2d.strokeStyle = "black";
        ctx2d.moveTo(objdiv_center_x, 0);
        ctx2d.lineTo(objdiv_center_x, vh);
        ctx2d.stroke();

        // Vertical line which marks left part after the round corners
        ctx2d.beginPath();
        ctx2d.strokeStyle = "grey";
        ctx2d.moveTo(objdiv_x + 10, 0);
        ctx2d.lineTo(objdiv_x + 10, vh);
        ctx2d.stroke();

        // Vertical line which marks right part before the round corners
        ctx2d.beginPath();
        ctx2d.strokeStyle = "grey";
        ctx2d.moveTo(objdiv_x + objdiv_w - 10, 0);
        ctx2d.lineTo(objdiv_x + objdiv_w - 10, vh);
        ctx2d.stroke();

        // Draw the object
        ctx2d.beginPath();
        ctx2d.strokeStyle = "red";
        ctx2d.arc(object_x, object_y, 10, 0, 2 * Math.PI);
        ctx2d.stroke();
        ctx2d.closePath();

        // Draw red line from center point to object
        ctx2d.beginPath();
        ctx2d.strokeStyle = "red";
        ctx2d.moveTo(angle_center_x, angle_center_y);
        ctx2d.lineTo(object_x, object_y);
        ctx2d.stroke();
      }
    </script>
    <style>
      body, html {
        margin: 0px;
        padding: 0px;
      }

      .ktv-objinfo {
          position: absolute;
          /*display: none;*/
          background: black;
          border: 1px solid white;
          padding: 10px;
          color: white;
          border-radius: 10px;
          box-shadow: 0 0 7px black;
          white-space: nowrap;
      }

      #kolkturmviewer {
        height: 100vh;
        background-color: aqua;
      }

      #kolkturmviewer canvas {
        vertical-align: bottom;
      }

      #arrow {
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <div id="kolkturmviewer">
      <div id="objdiv" class="ktv-objinfo">
        <svg id="arrow"
          width="20"
          height="20"
          xmlns="http://www.w3.org/2000/svg">
          <path id="lineAB" d="M 0 20 l 10 -20 l 10 20 q -10 -5 -20 0" fill="black" stroke="white" />
        </svg>
        <!-- <div id="arrow" style="display: block; width: 20px; height: 20px; border: 0; background-color: whitesmoke;"></div> -->
        What is that?
      </div>
    </div>
  </body>
</html>
